<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/dis_ind.css">
</head>
<body>

    <header class="custom-navbar">
        <div class="logo-area">
            <span class="gold-text">AGENDA</span><span class="white-text">DECITAS</span>
        </div>
        
         <nav class="nav-menu">
            <a href="welcome.html" class="btn-ingresar" style="text-decoration: none; display: block; text-align: center;">INICIO</a>
            <a href="+Tratamientos.html" class="btn-ingresar" style="text-decoration: none; display: block; text-align: center;">MÁS TRATAMIENTOS</a>
            <a href="miscitas.html" class="btn-ingresar" style="text-decoration: none; display: block; text-align: center;">MIS CITAS</a>
            <a href="Sucursales.html" class="btn-ingresar" style="text-decoration: none; display: block; text-align: center;">SUCURSALES</a> 
            <a href="index.html" class="btn-ingresar" style="text-decoration: none; display: block; text-align: center;">SALIR</a>
        </nav>
        
        <div class="spacer"></div>
    </header>

    <main class="container">
        <form action="/guardarCita" method="POST">
            <section class="form-section">
                <h2 class="section-title">1. Ubicación y Profesional</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-store"></i> Sucursal</label>
                        <select name="fk_id_sucursal" required>
                            <option value="" disabled selected>Seleccione sucursal...</option>
                            <option value="1">CENTRO HISTÓRICO</option>
                            <option value="2">SANTA FE</option>
                            <option value="3">LA PIEDAD</option>
                            <option value="4">PLAZA NORTE</option>
                            <option value="5">ZONA SUR</option>
                            <option value="6">EL MIRADOR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user-tie"></i> Especialista</label>
                        <select name="fk_id_empleado" required>
                            <option value="" disabled selected>Cualquier especialista</option>
                            <option value="10">Ana García</option>
                            <option value="11">Roberto Flores</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="form-section">
                <h2 class="section-title">2. Elija su Tratamiento</h2>
                <div class="form-group full-width">
                    <label class="instruction-label">Seleccione un servicio de la lista:</label>
                    <select name="fk_id_servicio" size="10" class="custom-listbox" required>
                        <optgroup label="--- TRATAMIENTOS DE CABELLO ---">
                            <option value="1">Largo y Liso Natural</option>
                            <option value="2">Color Atrevido</option>
                            <option value="5">Planchado y Rizado</option>
                            <option value="6">Tratamiento de Queratina</option>
                            <option value="8">Corte de Cabello</option>
                        </optgroup>
                        <optgroup label="--- CUIDADO FACIAL ---">
                            <option value="3">Hidratación Facial Profunda</option>
                            <option value="7">Exfoliación y Nutrición</option>
                        </optgroup>
                        <optgroup label="--- CUIDADO CORPORAL ---">
                            <option value="4">Reafirmantes Corporales</option>
                            <option value="9">Masaje Relajante</option>
                        </optgroup>
                    </select>
                </div>
            </section>

            <section class="form-section">
                <h2 class="section-title">3. Sus Datos y Horario</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" 
                               name="tx_nombre" 
                               placeholder="Nombre y Apellidos" 
                               required 
                               pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ ]+" 
                               oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ ]/g, '')">
                    </div>
                    <div class="form-group">
                        <label>Seleccione Fecha</label>
                        <input type="date" id="fecha_cita" name="fecha_cita" required>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Horarios Disponibles (8:00 AM - 7:00 PM)</label>
                        <select name="hora_cita" id="hora_select" required disabled>
                            <option value="">Primero elija una fecha...</option>
                        </select>
                    </div>
                </div>
                <a href="miscitas.html" class="btn-ingresar" style="text-decoration: none; display: block; text-align: center;">AGENDAR CITA</a>
                 
            </section>
        </form>
    </main>

    <script>
        // Bloquear días pasados
        const inputFecha = document.getElementById('fecha_cita');
        const hoy = new Date().toISOString().split('T')[0];
        inputFecha.setAttribute('min', hoy);

        inputFecha.addEventListener('change', function() {
            const horaSelect = document.getElementById('hora_select');
            horaSelect.disabled = false;
            horaSelect.innerHTML = '<option value="" disabled selected>Cargando disponibilidad...</option>';

            // Simulación de horarios ya ocupados en la base de datos para esta fecha
            const horariosOcupados = ["10:00", "14:00", "17:00"]; 

            setTimeout(() => {
                horaSelect.innerHTML = '<option value="" disabled selected>Elija una hora libre</option>';
                
                // Rango de 8 AM (8) a 7 PM (19)
                for (let i = 8; i <= 19; i++) {
                    let horaH = (i < 10 ? '0' + i : i) + ':00';
                    
                    // Si la hora NO está ocupada, se agrega al menú
                    if (!horariosOcupados.includes(horaH)) {
                        let opt = document.createElement('option');
                        opt.value = horaH;
                        let label = i > 12 ? (i-12) + ':00 PM' : i + ':00 AM';
                        opt.textContent = label;
                        horaSelect.appendChild(opt);
                    }
                }
            }, 400);
        });

    ///////////////////////////////////////////////////////////////
        fetch('/api/citas/agendar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        tx_nombre: nombre,
        fecha_cita: fecha,
        hora_cita: hora
    })
})
.then(res => res.json())
.then(data => {
    if(data.success) {
        window.location.href = "miscitas.html";
    } else {
        alert(data.message); 
    }
});

    </script>
</body>
</html>